name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # Create resourcepack zip
      # =========================
      - name: Create zip archive
        run: |
          ZIP_NAME="GTNH-FTI-Faithful-${GITHUB_REF_NAME}.zip"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

          zip -r "$ZIP_NAME" assets pack.mcmeta pack.png

      # =========================
      # Extract changelog section
      # =========================
      - name: Extract changelog for this version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "Extracting changelog for version $VERSION"

          awk "/## Version: $VERSION/{flag=1;next}/## Version: /{flag=0}flag" CHANGELOG.md > RELEASE.md

          echo "Generated RELEASE.md:"
          cat RELEASE.md

      # =========================
      # Create GitHub Release
      # =========================
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE.md
          files: ${{ env.ZIP_NAME }}
